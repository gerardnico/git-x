#!/usr/bin/env bash
# for doc, see markdown file

set -TCEeuo pipefail # Strict Bash

# Bash lib library path detection
if [ "${GITURE_BASH_LIB_PATH:-}" == "" ]; then
  if command -v "brew" > /dev/null 2>&1; then
    GITURE_BASH_LIB_PATH="$(brew --prefix giture)/lib"
  else
    echo "error: GITURE_BASH_LIB_PATH is not set and a brew installation was not found"
    exit 1
  fi
fi

# shellcheck source=../../bash-lib/lib/bashlib-doc.sh
source "${GITURE_BASH_LIB_PATH}/bashlib-doc.sh"
# shellcheck source=../../bash-lib/lib/bashlib-git.sh
source "${GITURE_BASH_LIB_PATH}/bashlib-git.sh"

function synopsis() {

  cat << EOF
Lint, check and prepare the next commit with pre-commit
\`\`\`bash
$(basename "$0")
\`\`\`
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

ROOT_DIRECTORY=$(git::get_root_directory)
PRE_COMMIT_FILE="$ROOT_DIRECTORY/.pre-commit-config.yaml"
if [ ! -f "$PRE_COMMIT_FILE" ]; then
  echo::warn "git prepare was skipped because the pre-commit file was not found ($PRE_COMMIT_FILE)"
  exit 0
fi

# Installed
if ! command -v "pre-commit" > /dev/null 2>&1; then
  echo::warn "A pre-commit file was found but pre-commit is not installed."
  exit 1
fi

# Prepare is a Node.js convention command name to lint and correct file
git add -A && pre-commit run
