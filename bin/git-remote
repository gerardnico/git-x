#!/usr/bin/env bash

set -Eeuo pipefail

# Bash lib library path detection
if [ "${BASHLIB_PATH:-}" == "" ]; then
  SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}" || echo "${BASH_SOURCE[0]}")")" && pwd)"
  BASHLIB_PATH="$SCRIPT_DIR/../lib"
  if [ ! -d "$BASHLIB_PATH" ]; then
    echo "BASHLIB_PATH was not set and could not be found"
    exit 1
  fi
fi
export PATH="$BASHLIB_PATH:$PATH"

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "bashlib-doc.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "bashlib-git.sh"

function synopsis() {

  cat << EOF
\`\`\`bash
$(basename "$0")
\`\`\`
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

function github_runner_status() {
  echo ""
  echo "GitHub Actions Run:"
  gh run list
}

function git_remote() {
  echo ""
  echo "Git Remote:"
  git remote -v
}

function main() {

  git_remote

  github_runner_status

  git fetch
  behindCommits=$(git::get_commits_behind_of_upstream)
  aheadCommits=$(git::get_commits_ahead_of_upstream)
  echo ""
  echo "Commit sync:"
  echo "  * $behindCommits behind commits (to pull)"
  echo "  * $aheadCommits ahead commits (to push)"
  if [ "$behindCommits" != "0" ]; then
    echo ""
    echo "Commits you're behind (remote has, you don't)"
    git log HEAD..'@{u}' --oneline
  fi
  if [ "$aheadCommits" != "0" ]; then
    echo ""
    echo "Commits you're ahead (you have, remote doesn't)"
    git log '@{u}'..HEAD --oneline
  fi

  echo ""

}

main
