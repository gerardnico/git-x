#!/usr/bin/env bash
# for docs, see md file

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
error::set_strict_mode
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-echo.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-echo.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-git.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-command.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-command.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-path.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-path.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-doc.sh"


function synopsis(){

  cat <<EOF
List, switch to or create a branch
\`\`\`bash
$(basename "$0")  [branch_name]
\`\`\`
* without branch name, the local and remotes branches are list
* with a branch name
  * the branch is created if it does not exist
  * the work is stashed
  * the working branch is changed
  * the optional stashed work is popped
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

BRANCH_NAME=${1:-}
if [ "$BRANCH_NAME" = "" ]; then
  # list remote and local branch
  git branch --all --column=never
  exit 0
fi

# Nothing to commit but push
DIRTY_INDEX="no"
if git::is_dirty_index ; then
  DIRTY_INDEX="yes"
fi
if [ $DIRTY_INDEX == "yes" ]; then
  echo::info "Index is dirty, saving in stash"
  git stash
fi

if ! git::branch_exists "$BRANCH_NAME"; then
    echo::info "Creating branch $BRANCH_NAME"
    git branch "$BRANCH_NAME"
fi

echo::info "Switching to the branch $BRANCH_NAME"
git checkout "$BRANCH_NAME"

if [ $DIRTY_INDEX == "yes" ]; then
  echo::info "Index was dirty, popping the stash"
  git stash pop
fi

echo::success "Switched to the branch $BRANCH_NAME"
