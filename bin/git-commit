#!/usr/bin/env bash
# Create and add a commit to the log
# If you don't want to create a commit, uses git-backup
# It will add the actual working files in the last commit

# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
error::set_strict_mode
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-echo.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-echo.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-git.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-command.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-command.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-path.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-path.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-doc.sh"

function synopsis() {

  cat << EOF
\`\`\`bash
$(basename "$0") [--edit|-e] [Optional Commit Message]
\`\`\`
* if the commit message is not given, it will be generated with the files in the commit.
* \`--edit\` or \`-e\` will let you edit the message
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

# Nothing to commit but push
if ! git::is_dirty_index; then
  echo::warn "Nothing to commit"
  if git::is_dirty_commit; then
    echo::warn "Dirty commit: pushing"
    git push
  fi
  exit
fi

# Args parsing
COMMIT_MESSAGE=""
MESSAGE_EDIT=false
while [[ $# -gt 0 ]]; do
  case "$1" in
    -e | --edit)
      MESSAGE_EDIT=true
      ;;
    *)
      COMMIT_MESSAGE=${1}
      shift
      break
      ;;
  esac
  shift
done

# Commit Message
if [ "$COMMIT_MESSAGE" = "" ]; then
  COMMIT_MESSAGE=$(git::get_auto_commit_message)
  echo::info "DIRECTORY_NAME - Commit message generated: $COMMIT_MESSAGE"
fi

# `--renormalize` to correct the EOL in the working tree
# You get an error on Delete file and we need to take the last element
# Example of output:
#  M README.md
# D docs/lib/bashlib-crypto.md
#RM lib/bashlib-function.sh -> lib/bashlib-bash.sh
#?? docs/lib/bashlib-bash.md
# We read line by line to be able to hand
# jinja file name such as {% if package_manager == 'maven' %}.mvn{% endif %}/wrapper/maven-wrapper.properties
git diff --cached --name-only --diff-filter=d | while read -r MODIFIED_FILE; do
  git add --renormalize "$MODIFIED_FILE"
done

# renormalize does not add any file into the index
# we need to add it twice
git add -A

echo::info "Committing"
# We can't use echo::eval because the message may be on multiple lines
# Note: multiline is possible with
# * multiple -m: git commit -m "First line" -m "Second line" --edit
# * or a file: git commit -F message.txt --edit
COMMIT_ARGS=(commit -v -m "$COMMIT_MESSAGE")
if [ $MESSAGE_EDIT == true ]; then
  COMMIT_ARGS+=(--edit)
fi
git "${COMMIT_ARGS[@]}"

CURRENT_BRANCH_UPSTREAM=$(git::get_current_upstream_branch 2> /dev/null)
if [ "$CURRENT_BRANCH_UPSTREAM" != "" ]; then
  git push
  exit
fi

# No upstream yet
IFS=" " read -r -a remotes <<< "$(git remote)"
if [ ${#remotes[@]} -ne 1 ]; then
  echo::warn "The repository has ${#remotes[@]} remotes, we can't set an upstream"
  echo::warn "Add a remote with"
  echo::warn ""
  echo::warn "   git remote add origin git@hosting.com:namespace/name.git"
  echo::warn "or"
  echo::warn "   git remote add origin https://hosting.com:namespace/name.git"
  echo::warn ""
  exit 1
fi
echo::warn "Adding an upstream on the push"
echo::eval "git push -u ${remotes[0]} $(git::get_current_branch)"
