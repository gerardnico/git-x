#!/usr/bin/env bash
# See md file

set -Eeuo pipefail
# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-doc.sh"

function synopsis(){

  cat <<EOF
Git status for human
\`\`\`bash
$(basename "$0")
\`\`\`
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

function git_working_status() {
  modified=$(git ls-files -m)
  if [[ -n $modified ]]; then
    echo -e "Modified not staged:\n$modified"
  fi
  deleted=$(git ls-files -d)
  if [[ -n $deleted ]]; then
    echo ""
    echo -e "Deleted:\n$deleted"
  fi
  untracked=$(git ls-files -o)
  if [[ -n $untracked ]]; then
    echo ""
    echo -e "Not tracked (may be ignored):\n$untracked"
  fi
  if [[ -z $modified && -z $deleted && -z $untracked ]]; then
    echo "No modifications"
  fi
}

function git_status() {
  # for scripting: git status --porcelain
  # porcelain means give the output in an easy-to-parse format for scripts
  local vPorcelain
  vPorcelain=$(git status --porcelain)
  echo ""
  echo "Git Status:"
  if [[ -z $vPorcelain ]]; then
    echo "  No modifications"
    return
  fi
  # output:
  # for an unstaged file: `status space path`
  # for a staged file: `status space space path`
  echo "$vPorcelain" | while read -r fileStatusLine; do
    # fileStatus=${fileStatusLine:0:1} # not yet used
    fileStatusStaged=${fileStatusLine:1:2}
    if [ "${fileStatusStaged}" == '  ' ]; then
      inNextCommit=' (staged)'
      # filePath=${fileStatusLine:3} # not yet used
    else
      inNextCommit=' (unstaged)'
      # filePath=${fileStatusLine:2} # not yet used
    fi
    echo "$fileStatusLine$inNextCommit"
  done

}

git_working_status
git_status
