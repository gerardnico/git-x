#!/bin/bash
# Merge a feature branch


set -Eeuo pipefail
# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-doc.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-string.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-command.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-git.sh"

function synopsis(){

  cat <<EOF
\`\`\`bash
Merge a feature branch

$(basename "$0") commit message
\`\`\`
EOF

}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi


BRANCH_NAME=$(git::get_current_branch)
DEFAULT_BRANCH=$(git::get_default_branch)
if [[ "$BRANCH_NAME" == "$DEFAULT_BRANCH" ]]; then
  echo::error "It's not a feature branch, it's the default branch ($DEFAULT_BRANCH)"
  echo::error "You can't merge the default branch"
  exit 1
fi

echo::info "Check if branch $BRANCH_NAME is dirty"
command::echo_eval "git checkout $BRANCH_NAME"
if git::is_dirty_index ; then
  echo::err "The branch is dirty, commit, stash or rollback your changes"
  exit 1
fi
echo::info "Checkout to the default branch $DEFAULT_BRANCH"
command::echo_eval "git checkout $DEFAULT_BRANCH"
echo::info "Pull from $DEFAULT_BRANCH"
command::echo_eval "git pull origin $DEFAULT_BRANCH"
# The --squash option takes all the commits and condenses them into one WIP index on main
echo::info "Merge squash the $BRANCH_NAME"
command::echo_eval "git merge --squash $BRANCH_NAME"
if ! git-prepare; then
  echo::warn "Commit hooks have failed"
  echo::warn "Check the error and commit against $DEFAULT_BRANCH"
  exit 1
fi
COMMIT_MESSAGE=${1:-"Merge feature branch $BRANCH_NAME"}
echo::info "Commit"
BODY=$(git log --pretty=format:%s "$DEFAULT_BRANCH".."$BRANCH_NAME")
MESSAGE=$(cat <<-HereDoc
$COMMIT_MESSAGE

$BODY
HereDoc
)
git-commit "$MESSAGE"
echo::success "Done"
echo::success "Created commit with the following message:\n$MESSAGE"
echo::tip "Delete branch with:"
echo::tip "   git-feature-delete $BRANCH_NAME"

