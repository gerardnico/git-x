#!/bin/bash
# Delete a feature branch, see md file for documentation

set -Eeuo pipefail
# shellcheck source=../..//bash-lib/lib/bashlib-error.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-error.sh"
error::set_trap
# shellcheck source=../..//bash-lib/lib/bashlib-doc.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-doc.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-string.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-command.sh"
# shellcheck source=../..//bash-lib/lib/bashlib-git.sh
source "${BASHLIB_LIBRARY_PATH:-}${BASHLIB_LIBRARY_PATH:+/}bashlib-git.sh"

function synopsis() {

  cat << EOF
Delete a feature branch
\`\`\`bash
$(basename "$0") branch-name
\`\`\`
EOF
}

# Doc Synopsis
if [ "${1:-}" = "synopsis" ]; then
  synopsis
  exit 0
fi

# Help
if [[ "${1:-}" =~ -h|--help|help ]]; then
  doc::help synopsis
  exit 0
fi

BRANCH_NAME="${1:-}"
if [[ "${BRANCH_NAME}" == "" ]]; then
  BRANCH_NAME=$(git::get_current_branch)
fi

# branch protection
DEFAULT_BRANCH=$(git::get_default_branch)
if [[ "$BRANCH_NAME" == "$DEFAULT_BRANCH" ]]; then
  echo::error "You can't delete the default branch ($DEFAULT_BRANCH)"
  exit 1
fi

if ! git::branch_exists "$BRANCH_NAME"; then
  echo::warn "The branch $BRANCH_NAME was not found"
  exit 1
fi

command::echo_eval "git checkout $BRANCH_NAME"

echo::info "Check if branch $BRANCH_NAME is dirty"
command::echo_eval "git checkout $BRANCH_NAME"

if git::is_dirty_index; then
  echo::error "The branch is dirty, stash or rollback your changes"
  exit 1
fi

# Checkout to the default branch
DEFAULT_BRANCH=$(git::get_default_branch)
echo::info "Checkout to the default branch $DEFAULT_BRANCH"
command::echo_eval "git checkout $DEFAULT_BRANCH"

# Before deletion, check that all feature commits are in the main branch
COMMIT_DIFF=$(git log "$DEFAULT_BRANCH".."$BRANCH_NAME")
if [ "$COMMIT_DIFF" != "" ]; then
  echo::err "Not all commits from $BRANCH_NAME are in the default branch $DEFAULT_BRANCH"
  echo::err "$COMMIT_DIFF"
  exit 1
fi

# Delete
echo::info "Delete branch $BRANCH_NAME locally"
command::echo_eval "git branch -D $BRANCH_NAME"
echo::info "Delete branch $BRANCH_NAME Remotely"
command::echo_eval "git push origin --delete  $BRANCH_NAME"
echo::success "Done"
